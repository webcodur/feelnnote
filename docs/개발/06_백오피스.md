# 백오피스 개발 가이드

## 개요

Feel&Note 관리자 웹 애플리케이션. 사용자 앱(web)과 동일한 기술 스택 사용.

---

## 기술 스택

| 구분 | 기술 |
|------|------|
| 프레임워크 | Next.js 16 (App Router) |
| 언어 | TypeScript |
| 스타일 | Tailwind CSS 4 |
| 백엔드 | Supabase (동일 프로젝트) |
| 아이콘 | Lucide React |

---

## 프로젝트 구조

```
sw/web-bo/
├── .env                    # 환경변수 (web과 동일)
├── package.json            # 포트 3001
├── src/
│   ├── app/
│   │   ├── layout.tsx      # 루트 레이아웃
│   │   ├── page.tsx        # 대시보드 (/)
│   │   ├── login/
│   │   │   └── page.tsx    # 로그인
│   │   ├── users/
│   │   │   ├── page.tsx    # 사용자 목록
│   │   │   └── [id]/
│   │   │       └── page.tsx # 사용자 상세
│   │   ├── contents/
│   │   │   ├── page.tsx    # 콘텐츠 목록
│   │   │   └── [id]/
│   │   │       └── page.tsx # 콘텐츠 상세
│   │   ├── records/
│   │   │   └── page.tsx    # 기록 관리
│   │   ├── reports/
│   │   │   └── page.tsx    # 신고 관리
│   │   ├── titles/
│   │   │   └── page.tsx    # 칭호 관리
│   │   └── settings/
│   │       └── page.tsx    # 시스템 설정
│   ├── components/
│   │   ├── layout/
│   │   │   ├── Sidebar.tsx
│   │   │   └── Header.tsx
│   │   ├── ui/             # 공용 UI 컴포넌트
│   │   └── features/       # 기능별 컴포넌트
│   ├── actions/            # Server Actions
│   │   ├── admin/
│   │   │   ├── users.ts
│   │   │   ├── contents.ts
│   │   │   ├── records.ts
│   │   │   ├── reports.ts
│   │   │   └── stats.ts
│   │   └── auth/
│   │       └── login.ts
│   ├── lib/
│   │   └── supabase/
│   │       ├── client.ts
│   │       ├── server.ts
│   │       └── middleware.ts
│   ├── middleware.ts       # 인증/권한 체크
│   └── types/
│       └── admin.ts
└── public/
```

---

## 인증/인가

### 권한 체크 플로우

```
요청 → middleware.ts → 로그인 체크
                    → 로그인 안됨 → /login 리다이렉트
                    → 로그인 됨 → 권한 체크
                              → 관리자 아님 → 403 또는 메인 앱 리다이렉트
                              → 관리자 → 진행
```

### middleware.ts 구현

```typescript
// src/middleware.ts
import { NextResponse, type NextRequest } from 'next/server'
import { updateSession } from '@/lib/supabase/middleware'
import { createClient } from '@/lib/supabase/server'

export async function middleware(request: NextRequest) {
  const { supabaseResponse, user } = await updateSession(request)
  const pathname = request.nextUrl.pathname

  // 로그인 페이지는 통과
  if (pathname === '/login') {
    if (user) {
      return NextResponse.redirect(new URL('/', request.url))
    }
    return supabaseResponse
  }

  // 미인증 사용자
  if (!user) {
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // 관리자 권한 체크
  const supabase = await createClient()
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single()

  if (!profile || !['admin', 'super_admin'].includes(profile.role)) {
    // 권한 없음 - 메인 앱으로 리다이렉트 또는 403
    return NextResponse.redirect(new URL('http://localhost:3000', request.url))
  }

  return supabaseResponse
}
```

### profiles 테이블 role 필드

```sql
-- role 컬럼 추가 (없는 경우)
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS role TEXT DEFAULT 'user';

-- role enum 제약
ALTER TABLE profiles
ADD CONSTRAINT profiles_role_check
CHECK (role IN ('user', 'admin', 'super_admin'));

-- 관리자 계정 지정
UPDATE profiles
SET role = 'admin'
WHERE email = 'admin@example.com';
```

---

## 데이터베이스 접근

### RLS 정책

백오피스는 service_role 키 또는 관리자 전용 RLS 정책 사용.

```sql
-- 관리자용 정책 예시 (profiles 테이블)
CREATE POLICY "Admin can view all profiles"
ON profiles FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM profiles
    WHERE id = auth.uid()
    AND role IN ('admin', 'super_admin')
  )
);
```

### Server Actions 예시

```typescript
// src/actions/admin/users.ts
'use server'

import { createClient } from '@/lib/supabase/server'

export async function getUsers(page: number = 1, limit: number = 20) {
  const supabase = await createClient()

  const offset = (page - 1) * limit

  const { data, error, count } = await supabase
    .from('profiles')
    .select('*', { count: 'exact' })
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1)

  if (error) throw error

  return { users: data, total: count }
}

export async function suspendUser(userId: string, reason: string) {
  const supabase = await createClient()

  const { error } = await supabase
    .from('profiles')
    .update({
      status: 'suspended',
      suspended_at: new Date().toISOString(),
      suspended_reason: reason
    })
    .eq('id', userId)

  if (error) throw error

  // 감사 로그 기록
  await logAdminAction('suspend_user', { userId, reason })
}
```

---

## API 구조

### 관리자 전용 Actions

```
src/actions/admin/
├── stats.ts          # 대시보드 통계
│   ├── getDashboardStats()
│   ├── getUserGrowth()
│   └── getContentTrends()
├── users.ts          # 사용자 관리
│   ├── getUsers()
│   ├── getUser()
│   ├── suspendUser()
│   ├── unsuspendUser()
│   └── updateUserRole()
├── contents.ts       # 콘텐츠 관리
│   ├── getContents()
│   ├── getContent()
│   ├── updateContent()
│   └── hideContent()
├── records.ts        # 기록 관리
│   ├── getRecords()
│   ├── hideRecord()
│   └── deleteRecord()
├── reports.ts        # 신고 관리
│   ├── getReports()
│   ├── resolveReport()
│   └── rejectReport()
└── logs.ts           # 감사 로그
    ├── logAdminAction()
    └── getAdminLogs()
```

---

## UI 컴포넌트

### 레이아웃 구조

```typescript
// src/app/layout.tsx
export default function RootLayout({ children }) {
  return (
    <html lang="ko">
      <body>
        <div className="flex min-h-screen">
          <Sidebar />
          <div className="flex-1">
            <Header />
            <main className="p-6">{children}</main>
          </div>
        </div>
      </body>
    </html>
  )
}
```

### 공용 컴포넌트 (필요시 생성)

| 컴포넌트 | 설명 |
|----------|------|
| DataTable | 정렬/필터/페이지네이션 테이블 |
| SearchInput | 검색 입력 |
| StatusBadge | 상태 뱃지 (active, suspended 등) |
| ConfirmModal | 확인 모달 (삭제, 정지 등) |
| StatCard | 통계 카드 |

---

## 개발 로드맵

### Phase 1: 기본 구조 ✅

| 작업 | 상태 | 설명 |
|------|------|------|
| 프로젝트 생성 | ✅ | Next.js + Supabase 설정 |
| 로그인 페이지 | ✅ | 관리자 로그인 |
| 미들웨어 | ✅ | 인증/권한 체크 |
| 레이아웃 | ✅ | Sidebar + Header |
| 대시보드 | ✅ | 기본 통계 표시 |

### Phase 2: 사용자 관리 ✅

| 작업 | 상태 | 설명 |
|------|------|------|
| 사용자 목록 | ✅ | 검색/필터/페이지네이션 |
| 사용자 상세 | ✅ | 프로필 정보 |
| 정지/해제 | ✅ | 사용자 제재 기능 |
| 역할 변경 | ✅ | 관리자 권한 부여 |

### Phase 3: 콘텐츠/기록 관리

| 작업 | 상태 | 설명 |
|------|------|------|
| 콘텐츠 목록 | ⏳ | 전체 콘텐츠 조회 |
| 기록 검토 | ⏳ | 신고된 기록 처리 |
| 신고 관리 | ⏳ | 신고 처리 워크플로우 |

### Phase 4: 고급 기능

| 작업 | 상태 | 설명 |
|------|------|------|
| 상세 통계 | ⏳ | 차트/그래프 |
| 칭호 관리 | ⏳ | 칭호 CRUD |
| 시스템 설정 | ⏳ | 점검 모드, 기능 토글 |
| 감사 로그 | ⏳ | 관리자 활동 기록 |

---

## 실행 방법

```bash
cd sw/web-bo
pnpm install
pnpm dev
# http://localhost:3001
```

---

## 환경 변수

`.env` 파일 (web과 동일):

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
NEXT_PUBLIC_SITE_URL=http://localhost:3001
```

---

*06_백오피스.md - 최종 수정: 2025-12-15*
